<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Claude Max Token Tracker</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      background: #0d1117;
      color: #c9d1d9;
      padding: 24px;
      max-width: 900px;
      margin: 0 auto;
    }
    h1 { color: #58a6ff; margin-bottom: 8px; font-size: 24px; }
    .subtitle { color: #8b949e; margin-bottom: 24px; }
    .card {
      background: #161b22;
      border: 1px solid #30363d;
      border-radius: 8px;
      padding: 20px;
      margin-bottom: 16px;
    }
    .card h2 { font-size: 14px; color: #8b949e; margin-bottom: 12px; text-transform: uppercase; }
    .progress-row { display: flex; align-items: center; margin-bottom: 16px; }
    .progress-row:last-child { margin-bottom: 0; }
    .progress-label { width: 100px; font-size: 13px; color: #8b949e; }
    .progress-container { flex: 1; background: #21262d; border-radius: 6px; height: 24px; overflow: hidden; }
    .progress-bar {
      height: 100%;
      background: linear-gradient(90deg, #238636, #2ea043);
      transition: width 0.3s;
      display: flex;
      align-items: center;
      justify-content: flex-end;
      padding-right: 8px;
      font-weight: 600;
      font-size: 12px;
      min-width: 40px;
    }
    .progress-bar.warning { background: linear-gradient(90deg, #9e6a03, #d29922); }
    .progress-bar.danger { background: linear-gradient(90deg, #da3633, #f85149); }
    .progress-info { width: 140px; text-align: right; font-size: 12px; color: #8b949e; margin-left: 12px; }

    .btn-sm {
      padding: 4px 8px;
      font-size: 11px;
      border-radius: 4px;
      border: none;
      cursor: pointer;
      margin-left: 8px;
      width: auto;
    }
    .btn-danger { background: #da3633; color: white; }
    .btn-danger:hover { background: #f85149; }

    .stats { display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px; margin-top: 16px; padding-top: 16px; border-top: 1px solid #21262d; }
    .stat { text-align: center; }
    .stat-value { font-size: 20px; font-weight: 600; color: #f0f6fc; }
    .stat-label { font-size: 11px; color: #8b949e; margin-top: 4px; }

    .chart-container { height: 200px; }

    table { width: 100%; border-collapse: collapse; font-size: 13px; }
    th, td { padding: 8px; text-align: left; border-bottom: 1px solid #21262d; }
    th { color: #8b949e; font-weight: 500; }

    .form-row { display: flex; gap: 12px; margin-bottom: 12px; }
    .form-group { flex: 1; }
    .form-group label { display: block; font-size: 12px; color: #8b949e; margin-bottom: 4px; }
    input, button, select {
      width: 100%;
      padding: 10px 12px;
      border-radius: 6px;
      border: 1px solid #30363d;
      background: #0d1117;
      color: #c9d1d9;
      font-size: 14px;
    }
    input:focus, select:focus { outline: none; border-color: #58a6ff; }
    button {
      background: #238636;
      border: none;
      cursor: pointer;
      font-weight: 500;
    }
    button:hover { background: #2ea043; }

    .delete-btn {
      background: none;
      border: none;
      color: #f85149;
      cursor: pointer;
      padding: 4px 8px;
      width: auto;
    }
    .delete-btn:hover { text-decoration: underline; }
    .empty { color: #8b949e; text-align: center; padding: 24px; }
    .session-tag {
      display: inline-block;
      background: #21262d;
      padding: 2px 6px;
      border-radius: 4px;
      font-size: 11px;
      color: #58a6ff;
    }

    .calibration-log { margin-top: 16px; padding-top: 16px; border-top: 1px solid #21262d; }
    .calibration-log h3 { font-size: 12px; color: #8b949e; margin-bottom: 8px; }
    .calibration-entry {
      background: #21262d;
      padding: 8px 12px;
      border-radius: 4px;
      margin-bottom: 8px;
      font-size: 12px;
    }
    .calibration-entry .time { color: #8b949e; }
    .calibration-entry .data { color: #f0f6fc; margin-top: 4px; }
  </style>
</head>
<body>
  <h1>Claude Max Token Tracker</h1>
  <p class="subtitle">5x Plan Usage Monitor</p>

  <div class="card">
    <h2>Usage</h2>

    <div class="progress-row">
      <div class="progress-label">Session</div>
      <div class="progress-container">
        <div class="progress-bar" id="sessionBar">0%</div>
      </div>
      <div class="progress-info" id="sessionInfo">- / 2.5M</div>
      <button class="btn-sm btn-danger" onclick="markLimit('session')">Limit</button>
    </div>

    <div class="progress-row">
      <div class="progress-label">Weekly</div>
      <div class="progress-container">
        <div class="progress-bar" id="weeklyBar">0%</div>
      </div>
      <div class="progress-info" id="weeklyInfo">- / 17.4M</div>
      <button class="btn-sm btn-danger" onclick="markLimit('weekly')">Limit</button>
    </div>

    <div class="progress-row">
      <div class="progress-label">Monthly</div>
      <div class="progress-container">
        <div class="progress-bar" id="monthlyBar">0%</div>
      </div>
      <div class="progress-info" id="monthlyInfo">- / 45M</div>
    </div>

    <div class="stats">
      <div class="stat">
        <div class="stat-value" id="sessionTokens">-</div>
        <div class="stat-label">Session</div>
      </div>
      <div class="stat">
        <div class="stat-value" id="weeklyTokens">-</div>
        <div class="stat-label">Weekly</div>
      </div>
      <div class="stat">
        <div class="stat-value" id="apiCalls">-</div>
        <div class="stat-label">Calls</div>
      </div>
      <div class="stat">
        <input type="text" id="resetTime" placeholder="2:45" style="width:60px;text-align:center;padding:4px;">
        <div class="stat-label">Resets In</div>
      </div>
    </div>
  </div>

  <div class="card">
    <h2>Session API Calls</h2>
    <div class="chart-container">
      <canvas id="usageChart"></canvas>
    </div>
  </div>

  <div class="card">
    <h2>Calibration Log</h2>
    <p style="font-size: 12px; color: #8b949e; margin-bottom: 12px;">
      When Claude shows "limit reached", click "Session Hit Limit" to record the actual limit point.
    </p>
    <div id="calibrationLog"></div>
  </div>

  <div class="card">
    <h2>Recent API Calls</h2>
    <table id="sessionsTable">
      <thead>
        <tr><th>Time</th><th>Input</th><th>Output</th><th>Total</th><th>Model</th><th></th></tr>
      </thead>
      <tbody id="sessionsList"></tbody>
    </table>
    <div id="emptyState" class="empty" style="display: none">No sessions recorded yet</div>
  </div>

  <script>
    let chart = null;
    let usageData = {
      monthlyLimit: 45000000,
      weeklyLimit: 17400000,
      sessionLimit: 2500000,
      resetDay: 1,
      sessions: [],
      calibrations: [],
      sessionStartOverride: null
    };

    function formatNumber(n) {
      if (n >= 1e6) return (n / 1e6).toFixed(1) + 'M';
      if (n >= 1e3) return (n / 1e3).toFixed(1) + 'K';
      return n.toString();
    }

    function parseResetTime(str) {
      if (!str) return null;
      // Parse formats: "3:18", "3h 18m", "3 hr 18 min", "3h18m"
      const match = str.match(/(\d+)\s*[h:]\s*(\d+)/i);
      if (match) {
        return parseInt(match[1]) * 60 + parseInt(match[2]);
      }
      // Just minutes
      const minMatch = str.match(/^(\d+)$/);
      if (minMatch) return parseInt(minMatch[1]);
      return null;
    }

    function getSessionStart() {
      const resetInput = document.getElementById('resetTime').value;
      const resetMinutes = parseResetTime(resetInput);

      if (resetMinutes) {
        // Session is 5 hours (300 min). If reset in X min, started (300 - X) min ago
        const minutesAgo = 300 - resetMinutes;
        return new Date(Date.now() - minutesAgo * 60 * 1000);
      }

      // Default: 5-hour rolling window
      return new Date(Date.now() - 5 * 60 * 60 * 1000);
    }

    function getWeekStart() {
      const now = new Date();
      const day = now.getDay();
      const diff = now.getDate() - day + (day === 0 ? -6 : 1);
      return new Date(now.getFullYear(), now.getMonth(), diff, 0, 0, 0);
    }

    function getMonthStart() {
      const now = new Date();
      const resetDay = usageData.resetDay || 1;
      let start = new Date(now.getFullYear(), now.getMonth(), resetDay, 0, 0, 0);
      if (now.getDate() < resetDay) {
        start.setMonth(start.getMonth() - 1);
      }
      return start;
    }

    function getSessionsInRange(start) {
      return usageData.sessions.filter(s => new Date(s.timestamp) >= start);
    }

    function sumTokens(sessions) {
      return sessions.reduce((sum, s) => sum + (s.input || 0) + (s.output || 0), 0);
    }

    function getTimeLeft() {
      const resetInput = document.getElementById('resetTime').value;
      const resetMinutes = parseResetTime(resetInput);
      if (resetMinutes) {
        const h = Math.floor(resetMinutes / 60);
        const m = resetMinutes % 60;
        return `${h}h ${m}m`;
      }
      return '~5h';
    }

    function updateProgressBar(barId, infoId, used, limit) {
      const percent = Math.min(100, (used / limit) * 100);
      const bar = document.getElementById(barId);
      bar.style.width = Math.max(percent, 3) + '%';
      bar.textContent = percent.toFixed(1) + '%';
      bar.className = 'progress-bar' + (percent > 80 ? ' danger' : percent > 60 ? ' warning' : '');
      document.getElementById(infoId).textContent = `${formatNumber(used)} / ${formatNumber(limit)}`;
    }

    function updateUI() {
      const sessionStart = getSessionStart();
      const sessionSessions = getSessionsInRange(sessionStart);
      const weeklySessions = getSessionsInRange(getWeekStart());
      const monthlySessions = getSessionsInRange(getMonthStart());

      const sessionUsed = sumTokens(sessionSessions);
      const weeklyUsed = sumTokens(weeklySessions);
      const monthlyUsed = sumTokens(monthlySessions);

      updateProgressBar('sessionBar', 'sessionInfo', sessionUsed, usageData.sessionLimit);
      updateProgressBar('weeklyBar', 'weeklyInfo', weeklyUsed, usageData.weeklyLimit);
      updateProgressBar('monthlyBar', 'monthlyInfo', monthlyUsed, usageData.monthlyLimit);

      document.getElementById('sessionTokens').textContent = formatNumber(sessionUsed);
      document.getElementById('weeklyTokens').textContent = formatNumber(weeklyUsed);
      document.getElementById('apiCalls').textContent = sessionSessions.length;
      document.getElementById('sessionTimeLeft').textContent = getTimeLeft();

      // Sessions table
      const tbody = document.getElementById('sessionsList');
      const empty = document.getElementById('emptyState');

      if (usageData.sessions.length === 0) {
        tbody.innerHTML = '';
        empty.style.display = 'block';
      } else {
        empty.style.display = 'none';
        tbody.innerHTML = usageData.sessions
          .slice()
          .reverse()
          .slice(0, 50)
          .map((s, i) => {
            const idx = usageData.sessions.length - 1 - i;
            const dt = new Date(s.timestamp);
            const time = dt.toLocaleTimeString();
            const total = (s.input || 0) + (s.output || 0);
            const model = (s.note || '').replace('auto:', '').replace('sync:', '').trim() || '-';
            return `<tr>
              <td>${time}</td>
              <td>${formatNumber(s.input || 0)}</td>
              <td>${formatNumber(s.output || 0)}</td>
              <td>${formatNumber(total)}</td>
              <td><span class="session-tag">${model}</span></td>
              <td><button class="delete-btn" onclick="deleteSession(${idx})">x</button></td>
            </tr>`;
          })
          .join('');
      }

      updateChart(sessionSessions);
      updateCalibrationLog();
    }

    function updateChart(sessions) {
      // Group by minute for per-call visualization
      const recentSessions = sessions.slice(-100);
      const labels = recentSessions.map((s, i) => {
        const dt = new Date(s.timestamp);
        return dt.toLocaleTimeString([], {hour: '2-digit', minute: '2-digit'});
      });
      const data = recentSessions.map(s => (s.input || 0) + (s.output || 0));

      if (chart) {
        chart.data.labels = labels;
        chart.data.datasets[0].data = data;
        chart.update();
      } else {
        chart = new Chart(document.getElementById('usageChart'), {
          type: 'bar',
          data: {
            labels,
            datasets: [{
              label: 'Tokens',
              data,
              backgroundColor: recentSessions.map(s => {
                const note = s.note || '';
                if (note.includes('opus')) return '#238636';
                if (note.includes('haiku')) return '#1f6feb';
                return '#6e7681';
              }),
              borderRadius: 2
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: { legend: { display: false } },
            scales: {
              x: {
                grid: { display: false },
                ticks: { color: '#8b949e', maxRotation: 45, font: { size: 10 } }
              },
              y: {
                grid: { color: '#21262d' },
                ticks: { color: '#8b949e' }
              }
            }
          }
        });
      }
    }

    function updateCalibrationLog() {
      const container = document.getElementById('calibrationLog');
      const calibrations = usageData.calibrations || [];

      if (calibrations.length === 0) {
        container.innerHTML = '<p style="color: #6e7681; font-size: 12px;">No calibration points recorded yet.</p>';
        return;
      }

      container.innerHTML = calibrations.slice().reverse().slice(0, 10).map(c => `
        <div class="calibration-entry">
          <div class="time">${new Date(c.timestamp).toLocaleString()}</div>
          <div class="data">
            Tracked: ${formatNumber(c.trackedTokens)} tokens |
            Claude showed: ${c.claudePercent || '?'}% |
            Implied limit: ${formatNumber(c.impliedLimit || 0)}
          </div>
        </div>
      `).join('');
    }

    async function markLimit(type) {
      const claudePercent = prompt(`What percentage did Claude show for ${type} when limit was hit?`);
      if (!claudePercent) return;

      const pct = parseFloat(claudePercent);
      let tokens, limitType;

      if (type === 'session') {
        tokens = sumTokens(getSessionsInRange(getSessionStart()));
        limitType = 'session';
      } else if (type === 'weekly') {
        tokens = sumTokens(getSessionsInRange(getWeekStart()));
        limitType = 'weekly';
      }

      const impliedLimit = pct > 0 ? Math.round(tokens / (pct / 100)) : 0;

      const calibration = {
        timestamp: new Date().toISOString(),
        type: limitType,
        trackedTokens: tokens,
        claudePercent: pct,
        impliedLimit: impliedLimit
      };

      await fetch('/api/calibration', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(calibration)
      });

      alert(`${type} calibration recorded!\nTracked: ${formatNumber(tokens)}\nClaude: ${pct}%\nImplied limit: ${formatNumber(impliedLimit)}`);
      loadData();
    }

    async function loadData() {
      const res = await fetch('/api/usage');
      usageData = await res.json();
      updateUI();
    }

    async function deleteSession(idx) {
      if (!confirm('Delete this entry?')) return;
      await fetch('/api/delete-session', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ index: idx })
      });
      loadData();
    }

    // Update session start when reset time changes
    document.getElementById('resetTime').addEventListener('input', updateUI);

    loadData();
    setInterval(loadData, 10000);
  </script>
</body>
</html>
